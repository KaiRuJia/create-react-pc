name: Build and Generate Version

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯ï¼Œæˆ– PR åˆ° main æ—¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu è™šæ‹Ÿæœº

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆå¿…é¡»ï¼ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ğŸ‘ˆ å…³é”®ï¼æ‹‰å–å®Œæ•´ Git å†å²ï¼ˆå« tagsï¼‰

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'  # è‡ªåŠ¨ç¼“å­˜ node_modules
          registry-url: 'https://registry.npmmirror.com'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4. ç”Ÿæˆ version.jsonï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
      - name: Generate version.json
        run: npm run gen-version

      # 5. æ„å»ºé¡¹ç›®ï¼ˆå‡è®¾ä½ çš„æ„å»ºå‘½ä»¤æ˜¯ npm run buildï¼‰
      - name: Build project
        run: npm run build

      # 6. ä¸Šä¼ æ„å»ºäº§ç‰©ä¾›ä¸‹è½½
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: ./build
      # åœ¨ éƒ¨ç½²
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
